<!DOCTYPE html>
<html>
 <head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1, user-scalable=no">
 <title>Friends with Beer</title>
 <style>
  #beerMe {
     float: right;
     width: 45%;
     height: 45%;
     border-radius: 5px;
     margin-left: 10px;
  }
 </style>
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
<link href="resources/stylesheets/screen.css" rel="stylesheet" type="text/css"/>
 </head>
<body>
<div data-role="page" id="aboutview" >
   <div data-role="header"  data-position="fixed" data-id="brandingbar">
    <h1>About Friends with Beer</h1>
  </div>
   <div data-role="content">
    <div id="welcomeMsg">
    	<div id="beerintro"> <img id="beerMe" src="resources/images/beer2.jpg"> 
    		<p>In these uncertain economic times you need to keep your friends close, and your beer even closer. </p>
    		<p>This app quickly identifies your pals who are most likely to have your favorite brew on ice. Then it auto-generates a bogus excuse for you coming to visit, dials your friend, and lets the good times roll!</p>  
    		<p>No friends? No problem! Our app contains a video of "virtual" friends drinking, so you'll never need to drink alone again!</p> 
    	</div>
     </div>
  </div>
  <div data-role="footer" data-id="nav" data-position="fixed">
    <div data-role="navbar" data-iconpos="top" class="navbaricons" role="navigation">
       <ul>
        <li><a href="#aboutview" data-transition="slide" id="aboutlink" class="ui-btn-active ui-state-persist" data-icon="custom">About</a></li>
        
        <li><a href="#friendsview"  data-transition="slide" id="friendslink" data-icon="custom" >Friends</a></li>
        
        <li><a href="#beersview"   data-transition="slide" id="beerslink" data-icon="custom">Beers</a></li>
        
        <li><a href="#beermeview"  data-transition="slide"  id="beermelink" data-icon="custom">Beer Me!</a></li>
        
        <li><a href="#drinkview"  data-transition="slide" id="drinklink" data-icon="custom">Drink</a></li>
      </ul>
     </div>
  </div>
 </div>


<!-- friendsview -->


<div data-role="page" id="friendsview">
   <div data-role="header"  data-position="fixed" data-id="brandingbar">
    <h1>Friends with Beer</h1>
    <a href="#editForm" 
      data-transition="flip" 
      onClick="friendId=null"
      data-role="button" 
      data-icon="plus" 
      class="ui-btn-right">Add</a>
   </div>
   <div data-role="content">
    <ul data-role="listview" id="friendsList" data-autodividers="true" data-filter="true" >
       
     </ul>
  </div>
  <div data-role="footer" data-id="nav" data-position="fixed" class="nav-glyphish-example">
    <div data-role="navbar" data-iconpos="top" class="navbaricons">
       <ul>
        <li><a href="#aboutview" data-transition="slide" id="aboutlink" data-icon="custom">About</a></li> 
        <li><a href="#friendsview"  class="ui-btn-active ui-state-persist"  data-transition="slide" id="friendslink" data-icon="custom" >Friends</a></li>
        <li><a href="#beersview"   data-transition="slide" id="beerslink" data-icon="custom">Beers</a></li>
        <li><a href="#beermeview"  data-transition="slide"  id="beermelink" data-icon="custom">Beer Me!</a></li>
        <li><a href="#drinkview"  data-transition="slide" id="drinklink" data-icon="custom">Drink</a></li>
      </ul>
     </div>
  </div>
</div>


<!-- page -->

<div data-role="page" id="editForm">
 <div data-role="header"  data-position="fixed" data-id="brandingbar">
   
   <a href="#friendsview" 
      data-transition="flip" 
      data-role="button" 
      data-icon="back">Back</a>
   
   <h1>Edit Friend Info</h1>
   
   <button 
      id="btnSaveFriend"
      data-icon="save" 
      class="ui-btn-right">Save</a>
 </div>
 <div data-role="content">
   <form  method="post" data-ajax="true" id="friendForm">
       <fieldset data-role="controlgroup">
        <div data-role="fieldcontain">
           <label for="firstNameField">First Name</label>
           <input type="text" name="firstName" id="firstNameField" data-prevent-focus-zoom="true" data-clear-btn="true" />
         </div>
        <div data-role="fieldcontain">
           <label for="lastNameField">Last Name</label>
           <input type="text" name="lastName" id="lastNameField" data-prevent-focus-zoom="true" data-clear-btn="true" />
        </div>
        <div data-role="fieldcontain">
           <label for="addressField">Address</label>
           <input type="text" name="address" id="addressField" data-prevent-focus-zoom="true"  data-clear-btn="true" />
        </div>
         <div data-role="fieldcontain">
           <label for="zipcodeField">Zip</label>
           <input type="text" name="zipcode" id="zipcodeField" data-prevent-focus-zoom="true" data-clear-btn="true" />
        </div>
        <div data-role="fieldcontain">
           <label for="emailField">E-mail</label>
           <input type="email" name="email" id="emailField" data-prevent-focus-zoom="true" data-clear-btn="true"/>
        </div>
        <div data-role="fieldcontain">
           <label for="phoneField">Phone</label>
           <input type="tel" name="phone" id="phoneField" data-prevent-focus-zoom="true" data-clear-btn="true"/>
        </div>
     </fieldset>
     
     <fieldset data-role="controlgroup">
        <div data-role="fieldcontain">
           <label for="latField">Lat</label>
           <input type="text" name="lat" id="latField" data-prevent-focus-zoom="true" data-mini="true" readonly="readonly"/>
        </div>
 
         <div data-role="fieldcontain">
           <label for="lngField">Lat</label>
           <input type="text" name="lng" id="lngField" data-prevent-focus-zoom="true" data-mini="true" readonly="readonly"/>
        </div>
        <div data-role="fieldcontain">
           <label  class="select">Favorite Beer:</label>
           <select name="beerId" id="beerIdField">
            <option value="">Please Select</option>
          </select>
         </div>
     </fieldset>
     <!--
       <fieldset class="ui-grid-a">
        <div 
        class="ui-block-b" 
        style="float:none; text-align:center; margin-left: auto; margin-right: auto">
           <button type="submit" data-theme="a">Geo</button>
        </div>
      </fieldset>
    -->
     </form>
 </div>
</div>

<!-- beersview -->

<div data-role="page" id="beersview">
   <div data-role="header"  data-position="fixed" data-id="brandingbar">
    <h1>Beers</h1>
   </div>

   <div data-role="content">
    <ul data-role="listview" data-autodividers="true" id="beersList"  data-filter="true" data-split-icon="info">
    </ul>
   </div>


<div data-role="footer" data-id="nav" data-position="fixed" class="nav-glyphish-example">
    <div data-role="navbar" data-iconpos="top" class="navbaricons">
       <ul>
        <li><a href="#aboutview" data-transition="slide" id="aboutlink" data-icon="custom">About</a></li>
        
        <li><a href="#friendsview"  data-transition="slide" id="friendslink" data-icon="custom" >Friends</a></li>
        
        <li><a href="#beersview" class="ui-btn-active ui-state-persist"   data-transition="slide" id="beerslink" data-icon="custom">Beers</a></li>
        
        <li><a href="#beermeview"  data-transition="slide"  id="beermelink" data-icon="custom">Beer Me!</a></li>
        
        <li><a href="#drinkview"  data-transition="slide" id="drinklink" data-icon="custom">Drink</a></li>
      </ul>
     </div>
  </div>
</div>

<!-- beer me -->

<div data-role="page" id="beermeview">
  <div data-role="header"  data-position="fixed" data-id="brandingbar">
    <h1>Beer Me</h1>
  </div>

  <div class="ui-bar ui-bar-c" style="height: 60px;">
   <div style="width: 80%; height: 100%; float: left;" id="friendDetail">
    
   </div>
   <div style="float: right; width: 50px">
    <input type="button" data-theme="a" data-iconpos="top" data-icon="tel">
   </div>
  </div>

  <div data-role="content"> 
    <div class="ui-bar-c ui-corner-all ui-shadow" style="padding:1em;">
      <div id="map_canvas" style="height:180px;"></div>
    </div>
  </div>


  <div data-role="footer" data-id="nav" data-position="fixed" class="nav-glyphish-example">
    <div data-role="navbar" data-iconpos="top" class="navbaricons">
       <ul>
        <li><a href="#aboutview" data-transition="slide" id="aboutlink" data-icon="custom">About</a></li>  
        <li><a href="#friendsview"  data-transition="slide" id="friendslink" data-icon="custom" >Friends</a></li>   
        <li><a href="#beersview"   data-transition="slide" id="beerslink" data-icon="custom">Beers</a></li>     
        <li><a href="#beermeview" class="ui-btn-active ui-state-persist" data-transition="slide"  id="beermelink" data-icon="custom">Beer Me!</a></li>     
        <li><a href="#drinkview"    data-transition="slide" id="drinklink" data-icon="custom">Drink</a></li>
      </ul>
     </div>
  </div>
</div>



<div data-role="page" id="drinkview">
  <div data-role="header"  data-position="fixed" data-id="brandingbar">
    <h1>Drink Responsibly</h1>
  </div>

  <div data-role="content">
    <video  src="http://webapps.figleaf.com/arch101/friends.mp4" autoplay>
    </video>  
  </div>

  <div data-role="footer" data-id="nav" data-position="fixed" class="nav-glyphish-example">
    <div data-role="navbar" data-iconpos="top" class="navbaricons">
       <ul>
        <li><a href="#aboutview" data-transition="slide" id="aboutlink" data-icon="custom">About</a></li>  
        <li><a href="#friendsview"  data-transition="slide" id="friendslink" data-icon="custom" >Friends</a></li>   
        <li><a href="#beersview"   data-transition="slide" id="beerslink" data-icon="custom">Beers</a></li>     
        <li><a href="#beermeview"  data-transition="slide"  id="beermelink" data-icon="custom">Beer Me!</a></li>     
        <li><a href="#drinkview"  class="ui-btn-active ui-state-persist"  data-transition="slide" id="drinklink" data-icon="custom">Drink</a></li>
      </ul>
     </div>
  </div>
</div>


<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>

 <!-- Add Google Maps API -->
 <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true">
 </script>
 
 <!-- Add Google Maps / JQuery Plugin -->
 <script type="text/javascript" src="http://jquery-ui-map.googlecode.com/svn/trunk/ui/min/jquery.ui.map.full.min.js"> </script>

<!-- html5 local database -->
<script type="text/javascript" src="localdb.js"></script>

<!-- Google Maps plugin -->
<script type="text/javascript" src="ui/jquery.ui.map.js"></script>
<script type="text/javascript" src="ui/jquery.ui.map.services.js"></script>
<script type="text/javascript" src="ui/jquery.ui.map.extensions.js"></script>


<!-- fun with jqm -->
<script type="text/javascript">
    
    // global page init
    // load Beers data into localstorage
    
    var myApp = {beers: []};
    var initialized = false;
    var db = new FriendsWithBeerDB;
    var friendId = null;
    var currentMapMarker = null;


    geoCodeAddress = function(address,zip) {
      if (address != '' && zip != '') {
        $.ajax({
          type: 'GET',
          url: 'http://maps.googleapis.com/maps/api/geocode/json?sensor=true&address=' + escape(address) + " " + zip,
          async: true,
          dataType: 'json',
          success: function(result) {
            // write data to fields
            if (result.status == "OK") {
              var lat = result.results[0].geometry.location.lat;
              var lng = result.results[0].geometry.location.lng;
              $("#latField").val(lat);
              $("#lngField").val(lng);
            }

          },
          error: function(e) {
            console.log(e.message);
          }
        });
      }
    }

    $(document).bind('pageinit', function() {
      if (!initialized) {
        initialized = true;

        $.mobile.loading( 'show', {
          textVisible: true,
          theme: 'e',
          html: "Loading Data..."
        });

        // event listeners to trigger geocoding
        $("#addressField").on("change", function() {
          geoCodeAddress($('#addressField').val(), $('#zipcodeField').val());
        });

        $("#zipcodeField").on("change", function() {
          geoCodeAddress($('#addressField').val(), $('#zipcodeField').val());
        });

        // cache beer list in local storage
        $.ajax({
          type: 'GET',
          url: 'http://webapps.figleaf.com/arch101/dataservices/mobile/beer.cfc?method=getBeerList',
          async: true,
          jsonpCallback: 'jsonCallback',
          contentType: "application/json",
          dataType: 'jsonp',
          success: function(json) {
            // write data to local db
           
            db.importTable('beer',json);
            $.mobile.loading('hide');

          },
          error: function(e) {
            console.log(e.message);
          }
        });

        // configure event listeners

        $('#editForm').on("pageshow", function(event) {
          
          // populate select list
          db.runQuery("select beer.id,beer.name from beer order by beer.name", function(records) {
            var beerSelector = $("select#beerIdField");
            beerSelector.empty();
            var out="";
            for (var i=0; i<records.length; i++) {
              out+='<option value="' + records[i].id + '">' + records[i].name + "</option>";
            }
            beerSelector.append(out);

            if (friendId != null) {
              db.runQuery("select * from friend where id = " + friendId, function(records) {
                var rec = records[0];
                console.log(rec);
                for (var i in rec) {
                  $("#" + i + "Field").val(rec[i]);
                }
                $("#beerIdField").selectmenu("refresh", true);
              });
            }
          });

          // write to db
          $("#btnSaveFriend").on("click", function(event) {
              var fields = $("#friendForm").serializeArray();
              db.writeRecord('friend', friendId, fields, function() {
                $.mobile.changePage('#friendsview');
              });
          });

        });
  
        $('#beermeview').on("pageshow", function(event) {
            
            me = {
              populatePanel : function(rec) {
                console.log(rec);
                $("#friendDetail").html(
                  new String().concat(
                    rec.firstName + " " + rec.lastName + "<br />",
                    rec.address + " " + rec.zipcode + " <br />",
                    rec.name
                  )
                );
               

                // $('#map_canvas').gmap('clear', 'markers');
                $('#map_canvas').gmap('destroy');

                $('#map_canvas').gmap({
                    'center': rec.lat + "," + rec.lng, 
                    'zoom': 17, 
                    'disableDefaultUI': true, 
                    'callback': function() {
                      var self = this;
                      currentMapMarker = self.addMarker({
                        'position': this.get('map').getCenter(),
                         animation: google.maps.Animation.DROP
                      }).click(function() {
                        // self.openInfoWindow({ 'content': 'Hello World!' }, this);
                      });
                    }
                }); 
                $('#map_canvas').gmap('refresh');
              }
            };

            if (friendId == null) {  // get random
              db.runQuery("select count(*) as thecount from friend", 
                          function(records) {
                            var randomNum = Math.floor(Math.random() * records[0].thecount) + 1;
                            db.runQuery(new String().concat(" select friend.*, beer.name",
                                                            " from friend join beer on friend.beerId = beer.id",
                                                            " where friend.id not in ( ",
                                                            "    select id ",
                                                            "    from friend ",
                                                            "    limit " + (randomNum - 1),
                                                            " )",
                                                            " limit 1"), 
                                        function(records) {
                                            // random record returned here!
                                            me.populatePanel(records[0]);
                                        }
                            );
                          }
              );
           } else {

           }

        });

        $('#friendsview').on("pageshow", function(event) {

          var sql = new String().concat(
            ' select friend.id, friend.firstName, friend.lastName, beer.name',
            ' from friend inner join beer',
            ' on friend.beerId = beer.id',
            ' order by friend.lastName'
          );

          db.runQuery(sql, function(records) {
             
             $('#friendsList').empty();
             var out = "";
             for (var i=0; i<records.length; i++) {
                out += '<li data-icon="arrow-r" data-iconpos="right" data-value="' + records[i].id + '"><a href="#"><h3>' + records[i].lastName + ',' + records[i].firstName + '<br>' + records[i].name + "</a></h3>";
                out += '</li>';
              }       
              // output list items
              console.log(out);
              $('#friendsList').append(out);
              $('#friendsList').listview('refresh');


            // bind tap listener
            // bind a tap event listener
            $('#friendsList > li').bind('tap', function(e) {
              var targetValue = this.getAttribute('data-value');
              friendId = targetValue;
              $.mobile.changePage("#editForm");
            });
        });        
       });




        $('#beersview').on("pageshow", function(event) {
          
          var sql = new String().concat(
             'select beer.id,beer.name,beer.type,beer.country,count(friend.id) as thecount ',
             'from beer left join friend ',
             'on beer.id = friend.beerId ',
             'group by beer.id,beer.name,beer.type,beer.country ',
             'order by beer.country, beer.name'
          );
          // configure autodividers
          $( "#beersList" ).listview({
            autodividers: true,
            autodividersSelector: function ( li ) {
              return li.attr('country');
            }
          });

          db.runQuery(sql, function(records) {
              
              // delete list items
              $('#beersList').empty();
              // build list items
              var out = "";
              for (var i=0; i<records.length; i++) {
                out += '<li data-value="' + records[i].id + '" country="' + records[i].country + '"><h3>' + records[i].name + "</h3>"
                out += '<span class="ui-li-count">' + records[i].thecount + '</span>';
                out += '</li>';
              }       
              // output list items
              $('#beersList').html(out);
              $('#beersList').listview('refresh');
              
            }
          );
          
        });        

      }
    });

 </script>


</body>
</html>
